# Database Schema Reference

Complete reference for all database tables, columns, and data flow in the Semantic Classifier application.

---

## üìä Table Overview

| Table | Purpose | Records | Foreign Keys |
|-------|---------|---------|--------------|
| `sessions` | User workflow tracking | One per file upload session | None (parent table) |
| `uploads` | File upload metadata | One per uploaded file | `session_id` ‚Üí sessions |
| `classifications` | Classification results | One per classified text value | `session_id` ‚Üí sessions |
| `feedback` | User feedback | One per classification (optional) | `classification_id` ‚Üí classifications |
| `category_history` | Category version history | Multiple per session | `session_id` ‚Üí sessions |

---

## 1Ô∏è‚É£ SESSIONS Table

**Purpose**: Tracks the entire workflow from file upload to classification completion.

### Columns

| Column | Type | Nullable | Default | Description | Updated By |
|--------|------|----------|---------|-------------|------------|
| `id` | UUID | NO | `uuid_generate_v4()` | Primary key | System (on create) |
| `status` | VARCHAR(50) | NO | `'pending_upload'` | Workflow status | Multiple stages |
| `original_filename` | VARCHAR(255) | YES | NULL | Name of uploaded file | File upload |
| `file_type` | VARCHAR(20) | YES | NULL | File type (csv/excel) | File upload |
| `selected_sheet` | VARCHAR(100) | YES | NULL | Selected Excel sheet | Sheet selector |
| `selected_column` | VARCHAR(100) | YES | NULL | Column being classified | Column selector |
| `total_rows` | INTEGER | YES | NULL | Total rows in file | File upload |
| `total_columns` | INTEGER | YES | NULL | Total columns in file | File upload |
| `column_metadata` | JSONB | YES | NULL | All column statistics | Column selector |
| `categories` | JSONB | YES | NULL | Discovered categories | Category discovery |
| `num_categories` | INTEGER | YES | NULL | Number of categories | Category discovery |
| `llm_model` | VARCHAR(100) | YES | NULL | LLM model used | Category discovery |
| `llm_temperature` | FLOAT | YES | NULL | Temperature setting | Category discovery |
| `classification_sample_size` | INTEGER | YES | NULL | Sample size if sampled | Classification |
| `classification_mode` | VARCHAR(50) | YES | NULL | sample/full_dataset | Classification |
| `created_at` | TIMESTAMP | YES | `now()` | Creation timestamp | System (on create) |
| `updated_at` | TIMESTAMP | YES | `now()` | Last update timestamp | System (on update) |
| `expires_at` | TIMESTAMP | YES | NULL | Expiration timestamp | File upload (24h) |

### Status Values

| Status | Meaning | Set By |
|--------|---------|--------|
| `pending_upload` | Session created, no file yet | Session creation |
| `file_uploaded` | File uploaded and parsed | File upload |
| `categories_discovered` | Categories generated by LLM | Category discovery |
| `classification_in_progress` | Classification started | Classification start |
| `completed` | Classification finished | Classification end |

### Example Data

```json
{
  "id": "9279b676-6fd8-4aec-9f3a-e1733a7eda18",
  "status": "completed",
  "original_filename": "customer_feedback.xlsx",
  "file_type": "excel",
  "selected_sheet": "Sheet1",
  "selected_column": "Feedback",
  "total_rows": 1500,
  "total_columns": 8,
  "column_metadata": [
    {
      "name": "Feedback",
      "dtype": "object",
      "is_text": true,
      "avg_text_length": 145.2,
      "unique_values": 1450
    }
  ],
  "categories": [
    {
      "name": "Positive Feedback",
      "description": "Customer satisfaction and praise",
      "boundary": "Contains positive sentiment...",
      "examples": ["Great service!", "Love the product"]
    }
  ],
  "num_categories": 5,
  "llm_model": "gpt-4-turbo-preview",
  "llm_temperature": 0.1,
  "classification_mode": "full_dataset",
  "created_at": "2026-01-27T20:00:00Z",
  "updated_at": "2026-01-27T20:30:00Z"
}
```

### When Fields Are Updated

| Field | Updated When | Component/Function |
|-------|--------------|-------------------|
| `status` | Multiple times during workflow | Various components |
| `original_filename`, `file_type` | File upload | `file_upload.py` |
| `total_rows`, `total_columns` | File upload | `file_upload.py` |
| `selected_sheet` | Sheet selection | `sheet_selector.py` |
| `selected_column` | Column selection | `column_selector.py` |
| `column_metadata` | Column selection | `column_selector.py` |
| `categories`, `num_categories` | Category discovery/edit | `category_discovery.py` |
| `llm_model`, `llm_temperature` | Category discovery | `category_discovery.py` |
| `classification_mode`, `classification_sample_size` | Classification start | `classification_interface.py` |

---

## 2Ô∏è‚É£ UPLOADS Table

**Purpose**: Tracks uploaded files and their processing status.

### Columns

| Column | Type | Nullable | Default | Description | Updated By |
|--------|------|----------|---------|-------------|------------|
| `id` | UUID | NO | `uuid_generate_v4()` | Primary key | System |
| `session_id` | UUID | NO | - | Foreign key to sessions | File upload |
| `original_filename` | VARCHAR(255) | NO | - | Original filename | File upload |
| `file_type` | VARCHAR(20) | NO | - | csv or excel | File upload |
| `file_size_bytes` | BIGINT | NO | - | File size in bytes | File upload |
| `file_hash` | VARCHAR(64) | YES | NULL | MD5 hash for deduplication | File upload |
| `encoding` | VARCHAR(50) | YES | NULL | CSV encoding (e.g., utf-8) | File upload (CSV only) |
| `sheets` | JSONB | YES | NULL | Excel sheet names | File upload (Excel only) |
| `row_count` | INTEGER | NO | - | Number of rows | File upload |
| `column_count` | INTEGER | NO | - | Number of columns | File upload |
| `column_metadata` | JSONB | YES | NULL | Column statistics | File upload |
| `status` | VARCHAR(50) | NO | `'uploaded'` | Processing status | File upload |
| `error_message` | TEXT | YES | NULL | Error details if failed | File upload (on error) |
| `uploaded_at` | TIMESTAMP | YES | `now()` | Upload timestamp | System |
| `processed_at` | TIMESTAMP | YES | NULL | Processing completion time | File upload |

### Status Values

| Status | Meaning |
|--------|---------|
| `uploaded` | File uploaded successfully |
| `processing` | File being parsed |
| `processed` | File parsed successfully |
| `error` | Parsing error occurred |

### Example Data

```json
{
  "id": "a1b2c3d4-...",
  "session_id": "9279b676-...",
  "original_filename": "customer_feedback.xlsx",
  "file_type": "excel",
  "file_size_bytes": 245680,
  "file_hash": "5d41402abc4b2a76b9719d911017c592",
  "sheets": ["Sheet1", "Raw Data"],
  "row_count": 1500,
  "column_count": 8,
  "column_metadata": [
    {
      "name": "Customer ID",
      "dtype": "int64",
      "non_null_rows": 1500,
      "unique_values": 1450
    }
  ],
  "status": "processed",
  "uploaded_at": "2026-01-27T20:00:00Z",
  "processed_at": "2026-01-27T20:00:05Z"
}
```

---

## 3Ô∏è‚É£ CLASSIFICATIONS Table

**Purpose**: Stores individual classification results for each text value.

### Columns

| Column | Type | Nullable | Default | Description | Updated By |
|--------|------|----------|---------|-------------|------------|
| `id` | UUID | NO | `uuid_generate_v4()` | Primary key | System |
| `session_id` | UUID | NO | - | Foreign key to sessions | Classification |
| `input_text` | TEXT | NO | - | Original text classified | Classification |
| `row_index` | INTEGER | YES | NULL | Row number in original data | Classification |
| `predicted_category` | VARCHAR(255) | NO | - | Predicted category name | Classification |
| `confidence` | VARCHAR(20) | YES | NULL | high/medium/low | Classification |
| `llm_model` | VARCHAR(100) | YES | NULL | Model used | Classification |
| `llm_temperature` | FLOAT | YES | NULL | Temperature used | Classification |
| `tokens_used` | INTEGER | YES | NULL | Tokens consumed | Classification |
| `execution_time_ms` | INTEGER | YES | NULL | Processing time in ms | Classification |
| `success` | BOOLEAN | NO | TRUE | Classification succeeded | Classification |
| `error_message` | TEXT | YES | NULL | Error details if failed | Classification |
| `extra_data` | JSONB | YES | NULL | Additional metadata | Classification |
| `created_at` | TIMESTAMP | YES | `now()` | Classification timestamp | System |

### Example Data

```json
{
  "id": "f1e2d3c4-...",
  "session_id": "9279b676-...",
  "input_text": "Great product, very satisfied with the quality!",
  "row_index": 42,
  "predicted_category": "Positive Feedback",
  "confidence": "high",
  "llm_model": "gpt-4-turbo-preview",
  "llm_temperature": 0.1,
  "tokens_used": 45,
  "execution_time_ms": 1150,
  "success": true,
  "created_at": "2026-01-27T20:15:30Z"
}
```

### Bulk Insert

Classifications are inserted in bulk for efficiency:

```python
ClassificationRepository.bulk_create_classifications([
    {
        "session_id": session_id,
        "input_text": "...",
        "predicted_category": "...",
        ...
    },
    # ... more records
])
```

---

## 4Ô∏è‚É£ FEEDBACK Table

**Purpose**: Stores user feedback on classifications (future feature).

### Columns

| Column | Type | Nullable | Default | Description | Updated By |
|--------|------|----------|---------|-------------|------------|
| `id` | UUID | NO | `uuid_generate_v4()` | Primary key | System |
| `classification_id` | UUID | NO | - | Foreign key to classifications (unique) | Feedback submission |
| `original_prediction` | VARCHAR(255) | NO | - | What was predicted | Feedback submission |
| `user_correction` | VARCHAR(255) | YES | NULL | User's suggested category | Feedback submission |
| `is_correct` | BOOLEAN | YES | NULL | Was prediction correct? | Feedback submission |
| `is_helpful` | BOOLEAN | YES | NULL | Was classification helpful? | Feedback submission |
| `reason_text` | TEXT | YES | NULL | User's explanation | Feedback submission |
| `user_confidence` | VARCHAR(20) | YES | NULL | User's confidence level | Feedback submission |
| `signals` | JSONB | YES | NULL | Extracted signals (keywords, sentiment) | Processing |
| `created_at` | TIMESTAMP | YES | `now()` | Feedback timestamp | System |

### Example Data

```json
{
  "id": "e1d2c3b4-...",
  "classification_id": "f1e2d3c4-...",
  "original_prediction": "Neutral",
  "user_correction": "Positive Feedback",
  "is_correct": false,
  "is_helpful": true,
  "reason_text": "This is clearly positive, mentions satisfaction",
  "signals": {
    "keywords": ["satisfied", "quality"],
    "sentiment": "positive"
  },
  "created_at": "2026-01-27T20:20:00Z"
}
```

---

## 5Ô∏è‚É£ CATEGORY_HISTORY Table

**Purpose**: Tracks category modifications and refinements over time.

### Columns

| Column | Type | Nullable | Default | Description | Updated By |
|--------|------|----------|---------|-------------|------------|
| `id` | UUID | NO | `uuid_generate_v4()` | Primary key | System |
| `session_id` | UUID | NO | - | Foreign key to sessions | Category operations |
| `version` | INTEGER | NO | 1 | Version number | Category operations |
| `categories` | JSONB | NO | - | Snapshot of categories | Category operations |
| `change_type` | VARCHAR(50) | NO | - | Type of change | Category operations |
| `change_description` | TEXT | YES | NULL | What changed | Category operations |
| `user_feedback` | TEXT | YES | NULL | User's feedback that triggered change | Category refinement |
| `created_at` | TIMESTAMP | YES | `now()` | Change timestamp | System |

### Change Types

| Type | Meaning |
|------|---------|
| `initial_discovery` | First category generation |
| `user_edit` | Manual category editing |
| `llm_refinement` | LLM-based refinement |

### Example Data

```json
{
  "id": "d1c2b3a4-...",
  "session_id": "9279b676-...",
  "version": 2,
  "categories": [
    {
      "name": "Positive Feedback",
      "description": "Updated description...",
      "boundary": "...",
      "examples": ["..."]
    }
  ],
  "change_type": "user_edit",
  "change_description": "Merged 'Very Positive' into 'Positive Feedback'",
  "created_at": "2026-01-27T20:10:00Z"
}
```

---

## üîÑ Data Flow & Updates

### Complete Workflow

```
1. FILE UPLOAD (file_upload.py)
   ‚îú‚îÄ Create: sessions record
   ‚îÇ  ‚îî‚îÄ Fields: original_filename, file_type, total_rows, total_columns, status='file_uploaded'
   ‚îî‚îÄ Create: uploads record
      ‚îî‚îÄ Fields: all file metadata, column_metadata, file_hash, status='processed'

2. SHEET SELECTION (sheet_selector.py) [Excel only]
   ‚îî‚îÄ Update: sessions.selected_sheet

3. COLUMN SELECTION (column_selector.py)
   ‚îî‚îÄ Update: sessions.selected_column, sessions.column_metadata

4. CATEGORY DISCOVERY (category_discovery.py)
   ‚îú‚îÄ Update: sessions.categories, sessions.num_categories
   ‚îú‚îÄ Update: sessions.llm_model, sessions.llm_temperature
   ‚îú‚îÄ Update: sessions.status='categories_discovered'
   ‚îî‚îÄ Create: category_history record (change_type='initial_discovery')

5. CATEGORY EDITING (category_discovery.py)
   ‚îú‚îÄ Update: sessions.categories
   ‚îî‚îÄ Create: category_history record (change_type='user_edit')

6. CLASSIFICATION START (classification_interface.py)
   ‚îî‚îÄ Update: sessions.status='classification_in_progress'
              sessions.classification_mode, sessions.classification_sample_size

7. CLASSIFICATION EXECUTION (classification_interface.py)
   ‚îî‚îÄ Bulk Create: classifications records (one per value)
      ‚îî‚îÄ Fields: input_text, predicted_category, confidence, execution_time_ms, etc.

8. CLASSIFICATION COMPLETE (classification_interface.py)
   ‚îî‚îÄ Update: sessions.status='completed'
```

---

## üìã Required vs Optional Fields

### Sessions Table

**Required on Create:**
- `id` (auto-generated)
- `status` (default: 'pending_upload')

**Should be Filled During Workflow:**
- ‚úÖ `original_filename` - File upload
- ‚úÖ `file_type` - File upload
- ‚úÖ `total_rows` - File upload
- ‚úÖ `total_columns` - File upload
- ‚úÖ `selected_column` - Column selection
- ‚úÖ `column_metadata` - Column selection
- ‚úÖ `categories` - Category discovery
- ‚úÖ `num_categories` - Category discovery
- ‚úÖ `llm_model` - Category discovery
- ‚úÖ `llm_temperature` - Category discovery

**Optional:**
- `selected_sheet` - Only for multi-sheet Excel files
- `classification_sample_size` - Only if sampling mode
- `classification_mode` - Defaults to 'full_dataset'

### Uploads Table

**All Required on Create:**
- ‚úÖ `session_id`
- ‚úÖ `original_filename`
- ‚úÖ `file_type`
- ‚úÖ `file_size_bytes`
- ‚úÖ `row_count`
- ‚úÖ `column_count`

**Type-Specific:**
- `encoding` - CSV files only
- `sheets` - Excel files only

### Classifications Table

**All Required on Create:**
- ‚úÖ `session_id`
- ‚úÖ `input_text`
- ‚úÖ `predicted_category`
- ‚úÖ `success`

**Recommended:**
- ‚úÖ `row_index` - For tracking
- ‚úÖ `confidence` - From LLM
- ‚úÖ `llm_model` - For audit
- ‚úÖ `llm_temperature` - For audit
- ‚úÖ `execution_time_ms` - For performance tracking

---

## üîç Queries for Verification

### Check Session Completeness

```sql
SELECT
    id,
    status,
    original_filename,
    selected_column IS NOT NULL as has_column,
    categories IS NOT NULL as has_categories,
    (SELECT COUNT(*) FROM classifications WHERE session_id = sessions.id) as classification_count
FROM sessions
ORDER BY created_at DESC
LIMIT 10;
```

### Check Upload Records

```sql
SELECT
    u.original_filename,
    u.file_type,
    u.row_count,
    u.status as upload_status,
    s.status as session_status
FROM uploads u
JOIN sessions s ON s.id = u.session_id
ORDER BY u.uploaded_at DESC
LIMIT 10;
```

### Classification Statistics

```sql
SELECT
    s.original_filename,
    COUNT(c.id) as total_classifications,
    SUM(CASE WHEN c.success THEN 1 ELSE 0 END) as successful,
    AVG(c.execution_time_ms) as avg_time_ms,
    SUM(c.tokens_used) as total_tokens
FROM sessions s
LEFT JOIN classifications c ON c.session_id = s.id
WHERE s.status = 'completed'
GROUP BY s.id, s.original_filename
ORDER BY s.created_at DESC;
```

---

## üîí Row Level Security (RLS)

RLS is currently **open** (all users can access all data). To enable:

```bash
# Run in Supabase SQL Editor
psql -f migrations/sql/enable_rls.sql
```

Or manually in Supabase:
1. Go to Table Editor
2. Select each table
3. Click "Enable RLS"
4. Add policies for your authentication strategy

---

## üìù Notes

1. **JSONB Fields**: All JSONB fields are automatically sanitized to convert NumPy/Pandas types to JSON-serializable Python types

2. **Timestamps**: All timestamps are in UTC

3. **UUIDs**: All IDs use UUID v4 for uniqueness

4. **Cascading Deletes**: Deleting a session will delete all related uploads, classifications, and category history

5. **File Data**: The actual Excel/CSV data is **NOT** stored in the database, only metadata. The data remains in memory during the session.
